{% extends 'base_enhanced.html' %}

{% block css %}
<link href="/static/lightbox/css/lightbox.css" rel="stylesheet" />
{% endblock %}

{% block js %}
<script src="/static/highcharts/js/highcharts.js"></script>
<script src="/static/lightbox/js/lightbox.js"></script>
<script src="/static/js/history.manager.js"></script>
<script src="/static/js/manager.js"></script>
<script src="/static/js/date.manager.js"></script>
<script src="/static/js/users.manager.js"></script>
<script src="/static/js/params.manager.js"></script>
<script src="/static/js/categories.ui.js"></script>
<script src="/static/js/categories.manager.js"></script>
{% endblock %}

{% block jsready %}
PaletteManager.onReady(Logger, function() {
    var InCategoriesUI = CategoriesUI();
    var OutCategoriesUI = CategoriesUI();

    DateManager.onReady($('#current_month'), {{ year }}, {{ month }});
    HistoryManager.onReady(DateManager);
    UsersManager.onReady(Logger);
    ExpensesUI.onReady(
            Formatter, PaletteManager, $('#expenses'));
    ExpensesManager.onReady(Logger, ExpensesUI, DateManager);
    OutCategoriesUI.onReady(Formatter, PaletteManager, $('#out-categories'));
    InCategoriesUI.onReady(Formatter, PaletteManager, $('#in-categories'));
    CategoriesManager.onReady(Logger, PeriodParamsManager(DateManager, InCategoriesUI, 'period'));
    Manager.onReady(Logger, DateManager, 30000);

    Manager.update(function() {
        ExpensesManager.onUpdate();
        CategoriesManager.onUpdate();
    });
    Manager.monthChange(function(year, month) {
        DateManager.onMonthChange(year, month);
        HistoryManager.onMonthChange(year, month);
        ExpensesManager.onMonthChange(year, month);
        CategoriesManager.onMonthChange(year, month);
        OutCategoriesUI.onMonthChange(year, month);
        InCategoriesUI.onMonthChange(year, month);
    });

    ExpensesManager.addSubmit(function() {
        ExpensesManager.onUpdate();
        CategoriesManager.onUpdate();
    });
    ExpensesUI.addExpense(function(exp) {
        ExpensesManager.onAddExpense(exp);
    });

    CategoriesManager.newData(function(data) {
        OutCategoriesUI.onNewData(
            _.filter(data.stats.categories, PositiveAmount));
        InCategoriesUI.onNewData(
            _.filter(
                _.map(data.stats.categories, SwapAmountSign), PositiveAmount));
    });

    Manager.onUpdate(0);
});
{% endblock %}

{% block container %}
<span class="spacer20"></span>
<div class="row-fluid">
    <div class="span12">
        <h2 class="text-center"><span id="current_month"></span></h2>
        <ul class="nav nav-pills">
            <li class="pull-left"><a id="prev_month" href="#">&laquo; Previous Month</a>
            <li class="pull-right"><a id="next_month" href="#">Next Month &raquo;</a>
        </ul>
    </div>
</div>
<div class="row-fluid">
    <div class="span6 pull-right">
        <div class="row-fluid">
            <h3 class="text-center">Income</h3>
            <div id="in-categories">
                <div class="alert alert-info" style="display: none">
                    Want to know how much did you <strong>earn</strong> last
                    month, category by category?  You are looking in the right
                    place!  See the chart populating as as soon as you track
                    expenses...
                </div>
                <div id="in-categories-chart" class="categories-chart" style="min-width: 300px; height: 300px; margin: 0 auto"></div>
            </div>
        </div>
        <div class="row-fluid">
            <h3 class="text-center">Outcome</h3>
            <div id="out-categories">
                <div class="alert alert-info" style="display: none">
                    Want to know how much did you spent last month for each
                    tracked category?  You are looking in the right place!
                    Start adding expenses and see how charts animates...
                </div>
                <div id="out-categories-chart" class="categories-chart" style="min-width: 300px; height: 300px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
    <div class="span6" style="margin-left: 0px">
        <h3 class="text-center">By Date</h3>
        <div id="expenses">
            <div class="alert alert-info" style="display: none">
                All the tracked expenses for the current month will be listed here,
                one above the other, sorted by date.
            </div>
            <div id="expenses-inner"></div>
        </div>
    </div>
</div>
{% endblock %}
